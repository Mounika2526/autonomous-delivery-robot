<?xml version="1.0"?>
<robot name="delivery_bot">

  <!-- ===================== BASE LINK ===================== -->
  <!-- Root frame of the robot -->
  <link name="base_link">
    <!-- Put the chassis ABOVE the wheel axle so only the wheels touch the ground -->
    <visual>
      <origin xyz="0 0 0.15" rpy="0 0 0"/>
      <geometry>
        <!-- x y z in meters -->
        <box size="0.5 0.4 0.2"/>
      </geometry>
      <material name="gray">
        <color rgba="0.6 0.6 0.6 1.0"/>
      </material>
    </visual>

    <collision>
      <!-- Same box, also lifted up -->
      <origin xyz="0 0 0.15" rpy="0 0 0"/>
      <geometry>
        <box size="0.5 0.4 0.2"/>
      </geometry>
    </collision>

    <inertial>
      <!-- Reasonable mass & inertia for a small robot -->
      <mass value="10.0"/>
      <inertia ixx="1.0" ixy="0.0" ixz="0.0"
               iyy="1.0" iyz="0.0"
               izz="1.0"/>
    </inertial>
  </link>

  <!-- ===================== LIDAR ===================== -->
  <link name="lidar_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.05" length="0.05"/>
      </geometry>
      <material name="black">
        <color rgba="0.1 0.1 0.1 1.0"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.05" length="0.05"/>
      </geometry>
    </collision>

    <inertial>
      <mass value="0.5"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0"
               iyy="0.01" iyz="0.0"
               izz="0.01"/>
    </inertial>

    <!-- GAZEBO LASER SENSOR -->
    <gazebo reference="lidar_link">
      <sensor type="ray" name="laser_sensor">
        <always_on>true</always_on>
        <update_rate>10</update_rate>
        <visualize>true</visualize>

        <ray>
          <scan>
            <horizontal>
              <samples>360</samples>
              <resolution>1</resolution>
              <min_angle>-3.14</min_angle>
              <max_angle>3.14</max_angle>
            </horizontal>
          </scan>
          <range>
            <min>0.2</min>
            <max>6.0</max>
            <resolution>0.01</resolution>
          </range>
        </ray>

        <plugin name="gazebo_ros_laser" filename="libgazebo_ros_laser.so">
          <topicName>/scan</topicName>
          <frameName>lidar_link</frameName>
        </plugin>
      </sensor>
    </gazebo>
  </link>

  <!-- Lidar is above the lifted chassis -->
  <joint name="lidar_joint" type="fixed">
    <origin xyz="0 0 0.30" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="lidar_link"/>
  </joint>

  <!-- ===================== LEFT WHEEL ===================== -->
  <link name="left_wheel_link">
    <visual>
      <!-- Wheel axis is lateral (y) -->
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.07" length="0.03"/>
      </geometry>
      <material name="black2">
        <color rgba="0.05 0.05 0.05 1.0"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.07" length="0.03"/>
      </geometry>
    </collision>

    <inertial>
      <mass value="1.0"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0"
               iyy="0.01" iyz="0.0"
               izz="0.01"/>
    </inertial>
  </link>

  <!-- Wheel axle at base_link origin (z=0). Radius=0.07 => bottom at z=-0.07 -->
  <joint name="left_wheel_joint" type="continuous">
    <origin xyz="0 0.18 0.0" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="left_wheel_link"/>
    <!-- Lateral axis -->
    <axis xyz="0 1 0"/>
  </joint>

  <!-- ===================== RIGHT WHEEL ===================== -->
  <link name="right_wheel_link">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.07" length="0.03"/>
      </geometry>
      <material name="black3">
        <color rgba="0.05 0.05 0.05 1.0"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.07" length="0.03"/>
      </geometry>
    </collision>

    <inertial>
      <mass value="1.0"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0"
               iyy="0.01" iyz="0.0"
               izz="0.01"/>
    </inertial>
  </link>

  <joint name="right_wheel_joint" type="continuous">
    <origin xyz="0 -0.18 0.0" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="right_wheel_link"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- ===================== TRANSMISSIONS ===================== -->
  <transmission name="left_wheel_trans">
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="left_wheel_joint"/>
    <actuator name="left_wheel_motor">
      <mechanicalReduction>1</mechanicalReduction>
    </actuator>
  </transmission>

  <transmission name="right_wheel_trans">
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="right_wheel_joint"/>
    <actuator name="right_wheel_motor">
      <mechanicalReduction>1</mechanicalReduction>
    </actuator>
  </transmission>

  <!-- ===================== GAZEBO DIFF DRIVE PLUGIN ===================== -->
  <gazebo>
    <plugin name="gazebo_ros_diff_drive" filename="libgazebo_ros_diff_drive.so">

      <!-- Joints that act as wheels -->
      <leftJoint>left_wheel_joint</leftJoint>
      <rightJoint>right_wheel_joint</rightJoint>

      <!-- Geometry -->
      <wheelSeparation>0.36</wheelSeparation>
      <wheelDiameter>0.14</wheelDiameter>

      <!-- ROS topics -->
      <commandTopic>cmd_vel</commandTopic>
      <odometryTopic>odom</odometryTopic>
      <odometryFrame>odom</odometryFrame>
      <robotBaseFrame>base_link</robotBaseFrame>

      <!-- Behaviour / output -->
      <updateRate>30.0</updateRate>
      <publishTf>true</publishTf>
      <publishWheelTF>true</publishWheelTF>
      <publishWheelJointState>true</publishWheelJointState>

      <!-- Dynamics -->
      <wheelAcceleration>0.0</wheelAcceleration>
      <wheelTorque>5.0</wheelTorque>
      <commandTimeout>1.0</commandTimeout>
    </plugin>
  </gazebo>

</robot>
